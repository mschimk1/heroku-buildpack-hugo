#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>
set -euf -o pipefail


BUILD_DIR=$1
CACHE_DIR=$2

# Hugo version
DEFAULT_HUGO_VERSION="0.17"

compile_buildpack_dir=$(cd $(dirname $0); cd ..; pwd)
compile_buildpack_bin=$compile_buildpack_dir/bin

source $compile_buildpack_bin/common.sh

# Log supported/default Hugo version
status "Default supported Hugo version is $DEFAULT_HUGO_VERSION"

# Determine Hugo version for the app
if [ -f $BUILD_DIR/.hugo-version ]; then
  HUGO_VERSION=$(cat $BUILD_DIR/.hugo-version | sed -e "s/hugo-//")
else
  HUGO_VERSION=$DEFAULT_HUGO_VERSION
fi

HUGO_ARCHIVE_NAME_VERSION="hugo_${HUGO_VERSION}_linux-64bit"
HUGO_FILE_NAME=${HUGO_ARCHIVE_NAME_VERSION}.tgz
# Hugo archive URL ( download from github)
HUGO_PACKAGE=https://github.com/spf13/hugo/releases/download/v${HUGO_VERSION}/${HUGO_FILE_NAME}

mkdir -p $CACHE_DIR
cd $CACHE_DIR

# Download and unpack Hugo binaries
if [[ ! -d "$HUGO_ARCHIVE_NAME_VERSION" ]]; then
  mkdir -p $HUGO_ARCHIVE_NAME_VERSION | indent
  status "Downloading Hugo binary archive version ${HUGO_VERSION} from ${HUGO_PACKAGE}..."
  curl $HUGO_PACKAGE -L -s -o $HUGO_FILE_NAME | indent
  tar xz -C $HUGO_ARCHIVE_NAME_VERSION -f $HUGO_FILE_NAME
fi

cp $HUGO_ARCHIVE_NAME_VERSION/hugo $BUILD_DIR/$HUGO_ARCHIVE_NAME_VERSION | indent

status "Installing Hugo theme..."
mkdir -p $BUILD_DIR/themes
cd $BUILD_DIR/themes
#git clone 

cd $BUILD_DIR
status "Generating the site..."
mkdir -p static | indent
./$HUGO_ARCHIVE_NAME_VERSION --theme=hugo_theme_robust -D

# TODO: Remove project files except public

if [[ ! -e $BUILD_DIR/Staticfile ]]; then
# Create config file for static build pack
cat <<EOF >$BUILD_DIR/Staticfile
root: public
EOF
fi